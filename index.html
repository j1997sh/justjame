<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Just Jame</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
  background:#fff7f0;
  color:#111827;
}
header{
  position:sticky;top:0;
  background:#fff;
  border-bottom:1px solid #eee;
  padding:12px 16px;
  z-index:10;
}
h1{margin:0;font-size:18px}
.sub{font-size:12px;color:#6b7280}
main{
  max-width:1100px;
  margin:auto;
  padding:16px;
  display:grid;
  gap:16px;
}
@media(min-width:900px){
  main{grid-template-columns:1.2fr .8fr}
}
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.rest{margin-bottom:20px}
.cat{margin-top:14px}
.item{
  border:1px solid #eee;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}
.opts{margin-top:8px}
.opts label{
  display:flex;
  gap:8px;
  font-size:13px;
}
button{
  border:none;
  background:#ff7a00;
  color:white;
  border-radius:999px;
  padding:10px 14px;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#fff;
  color:#111;
  border:1px solid #eee;
}
.cartItem{
  border-bottom:1px dashed #eee;
  padding:10px 0;
}
.small{font-size:12px;color:#6b7280}
</style>
</head>

<body>
<header>
  <h1>Just Jame</h1>
  <div class="sub">Pick food Â· choose options Â· order sent</div>
</header>

<main>
  <section class="card">
    <h2>Restaurants</h2>
    <div id="restaurants"></div>
  </section>

  <section class="card">
    <h2>Basket</h2>
    <div id="cart"></div>
    <p><b>Total:</b> Â£<span id="total">0.00</span></p>
    <textarea id="note" placeholder="Notes..." style="width:100%;border-radius:12px;padding:10px"></textarea>
    <br><br>
    <button id="orderBtn">Place order</button>
    <button class="secondary" id="clearBtn">Clear</button>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyAy_584m9VYEQbxg6j0T_YQHS8WPMuvrN4",
  authDomain: "justjame-f44db.firebaseapp.com",
  projectId: "justjame-f44db"
});
const db = getFirestore(app);

const restaurantsEl = document.getElementById("restaurants");
const cartEl = document.getElementById("cart");
const totalEl = document.getElementById("total");
const noteEl = document.getElementById("note");

let cart = [];

function money(n){return n.toFixed(2)}

function renderCart(){
  cartEl.innerHTML="";
  let total=0;
  cart.forEach((i,idx)=>{
    total+=i.price;
    cartEl.innerHTML+=`
      <div class="cartItem">
        <b>${i.name}</b>
        ${i.options.length?`<div class="small">${i.options.join(", ")}</div>`:""}
        <div class="small">${i.restaurant}</div>
      </div>
    `;
  });
  totalEl.textContent=money(total);
}

function addToCart(item){
  cart.push(item);
  renderCart();
}

async function loadMenu(){
  const rests = await getDocs(collection(db,"restaurants"));
  for(const r of rests.docs){
    const rd=r.data();
    if(rd.active===false)continue;

    const rest=document.createElement("div");
    rest.className="rest";
    rest.innerHTML=`<h3>${rd.name}</h3><div class="small">${rd.description||""}</div>`;

    const cats=await getDocs(collection(db,"restaurants",r.id,"categories"));
    for(const c of cats.docs){
      const cd=c.data();
      const cat=document.createElement("div");
      cat.className="cat";
      cat.innerHTML=`<h4>${cd.name}</h4>`;

      // ðŸ”‘ THIS IS THE KEY PART
      // use category name as collection name
      const itemsCol = cd.name;

      try{
        const items=await getDocs(
          collection(db,"restaurants",r.id,"categories",c.id,itemsCol)
        );

        for(const it of items.docs){
          const id=it.data();
          if(id.available===false)continue;

          const item=document.createElement("div");
          item.className="item";

          let opts="";
          if(Array.isArray(id.options)){
            opts=`<div class="opts">${
              id.options.map(o=>`
                <label>
                  <input type="checkbox" value="${o}">
                  ${o}
                </label>
              `).join("")
            }</div>`;
          }

          item.innerHTML=`
            <b>${id.name}</b>
            <div class="small">${id.desc||""}</div>
            ${opts}
            <br>
            <button>Add</button>
          `;

          item.querySelector("button").onclick=()=>{
            const picked=[...item.querySelectorAll("input:checked")].map(i=>i.value);
            addToCart({
              restaurant: rd.name,
              name: id.name,
              price: Number(id.price||0),
              options: picked
            });
          };

          cat.appendChild(item);
        }
      }catch{}

      rest.appendChild(cat);
    }

    restaurantsEl.appendChild(rest);
  }
}

document.getElementById("orderBtn").onclick=async()=>{
  if(!cart.length)return alert("Basket empty");
  await addDoc(collection(db,"orders"),{
    createdAt:new Date(),
    items:cart,
    note:noteEl.value
  });
  alert("Order sent");
  cart=[];
  noteEl.value="";
  renderCart();
};

document.getElementById("clearBtn").onclick=()=>{
  cart=[];
  renderCart();
};

loadMenu();
</script>
</body>
</html>
